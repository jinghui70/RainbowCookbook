# 数据库访问设计目标

数据库访问由 db 插件提供，所有需要访问数据库的 Bundle 都应该依赖这个插件。

Rainbow 的数据库访问，是一个自洽且开放的设计，底层使用了 Spring 的 JdbcTemplate 设计并天然支持 O-R Mapping，全部的访问方法被封装到一个接口 `Dao` 之内。

设计的原则依然是简单，希望达到的目标如下：

### 目标一：与具体数据库无关

使用统一的逻辑数据类型，定义如下：

```
    public enum DataType {
        SMALLINT,
        INT,
        LONG,
        DOUBLE,
        NUMERIC,
        DATE,
        TIME,
        TIMESTAMP,
        CHAR,
        VARCHAR,
        CLOB,
        BLOB;
    }
```

参考 Hibernate 为不同数据库实现了分页、函数等不同语法的数据库方言。

### 目标二 数据库结构设计、测试库结构、开发库结构要一致，数据库结构设计变动可追溯

数据库结构属于代码的一部分，因此我们用 json 结构保存数据库模型，并放置于 db 插件的配置目录下。创建数据库的脚本都是通过工具从这个模型文件产生的，保证了库结构的一致性；同时模型文件是文本文件，保存在源码管理系统中可以很好的进行版本控制。

### 目标三 尽量使用简单的 SQL 语法，让代码易读

过于复杂的 SQL 语句对于代码阅读来说是非常困难的，特别是不同人维护的时候，因此不建议使用。复杂的 SQL 可以通过拆分或者使用后面描述的[高级操作](DatabaseX.md)来实现。

当极端要求性能，必须使用特定数据库语法时，dao 也提供了透明的直接发送 SQL 语句的函数，但是这样就破坏了数据库无关性，需要使用者抉择。

### 目标四 团队开发互不影响

如果开发时团队成员都依赖同一个开发库，库结构的改动，测试数据的变化都会导致混乱。rainbow 开发建议使用本地的数据库，在 build.xml 脚本中有 makeDevelopDatabase 命令可以一键生成新的开发数据库并灌入初始化数据与测试数据，保证了开发的效率。

测试团队也可以一键部署测试库，与开发团队隔离，保证系统的质量。

随着硬件的发展，开发机器性能越来越强，本地部署一个 Oracle、MySQL 都很容易了，但是基于简单的角度，建议使用 H2 数据库开发。makeDevelopDatabase 命令默认会在用户目录下建立一个 db 目录，并在其中生成 H2 的数据库文件。
